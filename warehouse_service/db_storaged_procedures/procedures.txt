DELIMITER //

CREATE PROCEDURE GetProducts(
    IN p_category_name VARCHAR(255),
    IN p_min_price DECIMAL(10,2),
    IN p_max_price DECIMAL(10,2),
    IN p_search_query VARCHAR(255),
    IN p_include_inactive BOOLEAN,
    IN p_include_out_of_stock BOOLEAN,
    IN p_limit INT,
    IN p_offset INT
)
BEGIN
    SELECT 
        p.id,
        p.name,
        p.sku,
        c.name as category_name,
        p.base_price,
        COALESCE(SUM(ps.quantity), 0) as total_quantity,
        p.is_active,
        p.created_at
    FROM products p
    JOIN categories c ON p.category_id = c.id
    LEFT JOIN product_stocks ps ON p.id = ps.product_id
    WHERE 
        (p_include_inactive = TRUE OR p.is_active = 1)
        AND (p_category_name IS NULL OR c.name = p_category_name)
        AND (p_min_price IS NULL OR p.base_price >= p_min_price)
        AND (p_max_price IS NULL OR p.base_price <= p_max_price)
        AND (p_search_query IS NULL OR p.name LIKE CONCAT('%', p_search_query, '%'))
    GROUP BY p.id, p.name, p.sku, c.name, p.base_price, p.is_active, p.created_at
    HAVING 
        (p_include_out_of_stock = TRUE OR total_quantity > 0)
    ORDER BY p.is_active DESC, total_quantity DESC, p.name
    LIMIT p_limit OFFSET p_offset;
END //

DELIMITER ;

DELIMITER //

CREATE PROCEDURE GetProductById(
    IN p_product_id INT
)
BEGIN
    SELECT 
        p.id,
        p.name,
        p.sku,
        c.name as category_name,
        p.base_price,
        COALESCE(SUM(ps.quantity), 0) as total_quantity,
        p.is_active,
        p.created_at,
        p.updated_at
    FROM products p
    JOIN categories c ON p.category_id = c.id
    LEFT JOIN product_stocks ps ON p.id = ps.product_id
    WHERE p.id = p_product_id
    GROUP BY p.id, p.name, p.sku, c.name, p.base_price, p.is_active, p.created_at, p.updated_at;
END //

DELIMITER ;